"""
Module for handling inline button removal functionality in the Telegram bot.
This module contains functions for removing inline buttons from messages before forwarding.
"""

import json
import logging
from telegram import InlineKeyboardButton, InlineKeyboardMarkup, ParseMode, Update
from telegram.ext import CallbackContext

# Configure logging
logger = logging.getLogger(__name__)

def load_config():
    """Load bot configuration from config.json file"""
    try:
        with open('config.json', 'r', encoding='utf-8') as file:
            config = json.load(file)
            return config
    except (FileNotFoundError, json.JSONDecodeError) as e:
        logger.error(f"Error loading config: {e}")
        return {}

def save_config(config):
    """Save configuration to config.json file"""
    try:
        with open('config.json', 'w', encoding='utf-8') as file:
            json.dump(config, file, ensure_ascii=False, indent=2)
            return True
    except Exception as e:
        logger.error(f"Error saving config: {e}")
        return False

def button_removal_menu(update, context):
    """Show the button removal menu."""
    config = load_config()
    
    # Get current status
    button_removal_enabled = config.get("button_removal_enabled", False)
    status = "âœ… Ù…ÙØ¹Ù‘Ù„" if button_removal_enabled else "âŒ Ù…Ø¹Ø·Ù‘Ù„"
    
    # Create keyboard with options
    keyboard = [
        [InlineKeyboardButton(
            f"Ø­Ø°Ù Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø´ÙØ§ÙØ©: {status}", 
            callback_data='toggle_button_removal'
        )],
        [InlineKeyboardButton(
            "ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©", 
            callback_data='advanced_features_menu'
        )]
    ]
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    # For callback queries
    if update.callback_query:
        query = update.callback_query
        query.answer()
        query.edit_message_text(
            'ğŸ”˜ *Ø­Ø°Ù Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø´ÙØ§ÙØ©*\n\n'
            'ØªØ­ÙƒÙ… ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø´ÙØ§ÙØ© Ù…Ù† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡Ù‡Ø§.\n\n'
            f'Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: *{status}*\n\n'
            'Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø©ØŒ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø´ÙØ§ÙØ© Ù…Ù† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡Ù‡Ø§.\n\n'
            'Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ù…Ø®ØªÙ„ÙØ© Ø¹Ù† ÙÙ„ØªØ± Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø´ÙØ§ÙØ©. ÙÙ„ØªØ± Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø´ÙØ§ÙØ© ÙŠÙ…Ù†Ø¹ ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø²Ø±Ø§Ø±ØŒ Ø£Ù…Ø§ Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© ÙØªØ­Ø°Ù Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØªÙˆØ¬Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø£Ø²Ø±Ø§Ø±.',
            parse_mode=ParseMode.MARKDOWN,
            reply_markup=reply_markup
        )
    # For direct commands
    else:
        update.message.reply_text(
            'ğŸ”˜ *Ø­Ø°Ù Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø´ÙØ§ÙØ©*\n\n'
            'ØªØ­ÙƒÙ… ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø´ÙØ§ÙØ© Ù…Ù† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡Ù‡Ø§.\n\n'
            f'Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: *{status}*\n\n'
            'Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø©ØŒ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø´ÙØ§ÙØ© Ù…Ù† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡Ù‡Ø§.\n\n'
            'Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ù…Ø®ØªÙ„ÙØ© Ø¹Ù† ÙÙ„ØªØ± Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø´ÙØ§ÙØ©. ÙÙ„ØªØ± Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø´ÙØ§ÙØ© ÙŠÙ…Ù†Ø¹ ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø²Ø±Ø§Ø±ØŒ Ø£Ù…Ø§ Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© ÙØªØ­Ø°Ù Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØªÙˆØ¬Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø£Ø²Ø±Ø§Ø±.',
            parse_mode=ParseMode.MARKDOWN,
            reply_markup=reply_markup
        )

def toggle_button_removal_status(update, context):
    """Toggle the button removal feature on/off."""
    query = update.callback_query
    query.answer()
    
    # Load config
    config = load_config()
    
    # Toggle setting
    current_status = config.get("button_removal_enabled", False)
    config["button_removal_enabled"] = not current_status
    
    # Save config
    success = save_config(config)
    
    if success:
        # Show the menu again with updated status
        button_removal_menu(update, context)
    else:
        # Show error
        query.edit_message_text(
            'âŒ *Ø®Ø·Ø£!*\n\n'
            'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.',
            parse_mode=ParseMode.MARKDOWN,
            reply_markup=InlineKeyboardMarkup([[
                InlineKeyboardButton("ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø©", callback_data='button_removal_menu')
            ]])
        )

def should_remove_buttons():
    """Check if buttons should be removed from messages.
    
    Returns:
        bool: True if buttons should be removed, False otherwise
    """
    # Load config
    config = load_config()
    
    # Check if feature is enabled
    return config.get("button_removal_enabled", False)